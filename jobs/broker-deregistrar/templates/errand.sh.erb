#!/bin/bash

set -eu

<% cf = link("cf") -%>
CF_API_URL='<%= cf.p("cf.api_url") %>'
CF_ADMIN_USERNAME='<%= cf.p("cf.username") %>'
CF_ADMIN_PASSWORD='<%= cf.p("cf.password") %>'
CF_SKIP_SSL_VALIDATION='<%= cf.p("cf.skip_ssl_validation") %>'

<% broker = link("servicebroker") -%>
BROKER_NAME='<%= broker.p("name") %>'

echo "CF_API_URL=${CF_API_URL}"
echo "CF_SKIP_SSL_VALIDATION=${CF_SKIP_SSL_VALIDATION}"
echo "CF_ADMIN_USERNAME=${CF_ADMIN_USERNAME}"
echo "BROKER_NAME=${BROKER_NAME}"

export PATH=/var/vcap/packages/cf-cli/bin

if [[ ${CF_SKIP_SSL_VALIDATION} == "true" ]]; then
  cf api ${CF_API_URL} --skip-ssl-validation
else
  cf api ${CF_API_URL}
fi

cf auth \
  ${CF_ADMIN_USERNAME} \
  ${CF_ADMIN_PASSWORD}

# broker.p("services") is a JSON array from servicebroker link
<% broker.p("services").each do |service| -%>
cf purge-service-offering <%= service[:name] %> -f
<% end -%>

cf delete-service-broker \
  ${BROKER_NAME} \
  -f
